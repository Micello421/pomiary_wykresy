<html>
  <head>
    <link rel="icon" type="image/png" href="icons/tabicon.png"/>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="js/augenmass-help.js"></script>
    <script src="js/augenmass-elements.js"></script>
    <script src="js/augenmass-model.js"></script>
    <script src="js/augenmass-view.js"></script>
    <script src="js/augenmass-loupe.js"></script>
    <script src="js/augenmass-main.js"></script>
    <style>
      body {
        background: #2f2f2f;
        color: #fff;
        font-size: 10pt;
        margin: 0;
        padding: 0;
        padding-top: 46px;
      }
      form {
        display: inline;
      }
      #toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        display: flex;
        align-items: center;
        gap: 0.6em;
        padding: 4px 10px;
        background: rgba(40, 40, 40, 0.98);
        border-bottom: 1px solid #444;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 10;
        font-size: 12px;
        line-height: 1;
        flex-wrap: nowrap;
        white-space: nowrap;
        overflow-x: auto;
        transform-origin: top left;
      }
      #toolbar .form-control,
      #toolbar .btn {
        border-radius: 0.5rem;
      }
      #toolbar .btn-group > .btn {
        border-radius: 0.5rem;
      }
      #toolbar .btn-group > .btn + .btn {
        margin-left: 0.35rem;
      }
      #toolbar form {
        display: flex;
        align-items: center;
        gap: 0.6em;
        flex-wrap: nowrap;
        white-space: nowrap;
      }
      #toolbar a {
        text-decoration: none;
      }
      #helptext {
        padding-left: 1em;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 120px;
      }
      #background-img,
      #measure {
        position: absolute;
        top: 46px;
        left: 10px;
        background: transparent;
      }
      #background-img {
        z-index: -1;
      }
      #measure {
        z-index: 0;
      }
      #loupe {
        position: fixed;  /* stays when rest scrolls. */
        opacity: 0;
        box-shadow: 3px 3px 15px;
        border-radius: 10px;
        color: #000;     /* influences shadow color. */
      }
      #download-result,
      #download-combined,
      #download-combined-table,
      #download-table-image,
      #download-table-csv {
        font-weight: 600;
      }
      #measurements-panel {
        position: fixed;
        top: 46px;
        right: 0;
        width: 260px;
        max-height: calc(100vh - 4em);
        background: rgba(60, 60, 60, 0.95);
        border-left: 1px solid #444;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
        color: #fff;
        transition: transform 0.2s ease-in-out;
        z-index: 5;
      }
      #measurements-panel.collapsed {
        transform: translateX(220px);
      }
      #measurements-toggle {
        position: absolute;
        left: -110px;
        top: 0;
        width: 110px;
        height: 32px;
        background: #444;
        color: #fff;
        border: 1px solid #222;
        cursor: pointer;
      }
      #measurements-body {
        padding: 8px 10px 10px 10px;
        overflow: auto;
        max-height: calc(100vh - 5em);
      }
      #measurements-title {
        font-weight: bold;
        margin-bottom: 6px;
      }
      #measurements-list {
        margin: 0;
        padding-left: 1.4em;
      }
      #tool-buttons {
        margin-left: 0.2em;
      }
      #measurements-scale {
        font-size: 10pt;
        margin-bottom: 6px;
        color: #ddd;
      }
      #chart-analysis-section {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 85vh;
        background: rgba(40, 40, 40, 0.98);
        border-top: 2px solid #444;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        z-index: 20;
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
      }
      #chart-analysis-section.open {
        transform: translateY(0);
      }
      #chart-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 21;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      #chart-header {
        padding: 10px 20px;
        background: #333;
        border-bottom: 1px solid #555;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-shrink: 0;
      }
      #chart-body {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
      }
      .chart-container {
        background: #2f2f2f;
        border: 1px solid #555;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 40px;
      }
      .chart-canvas-wrapper {
        width: 100%;
        height: 500px;
        position: relative;
      }
      .chart-canvas-wrapper canvas {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        margin: 20px 0;
      }
      .stats-box {
        background: #3a3a3a;
        border-left: 3px solid #4a90e2;
        padding: 10px 15px;
        margin-top: 10px;
        font-size: 11pt;
      }
      .chart-download-btn {
        margin-top: 15px;
      }
      .file-section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 10px;
        border-bottom: 2px solid #555;
      }
      .summary-block {
        background: #2f2f2f;
        border: 1px solid #555;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 25px;
      }
      .summary-title {
        font-weight: 600;
        margin-bottom: 10px;
      }
      .measurements-summary {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 6px 12px;
      }
      .summary-item {
        background: #2b2b2b;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11pt;
      }
      #speed-summary-section {
        margin-bottom: 40px;
      }
      .speed-inputs {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 10px 16px;
      }
      .speed-input-row {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #2b2b2b;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 8px 10px;
      }
      .speed-input-row label {
        flex: 1;
        font-size: 10pt;
        color: #ddd;
      }
      .speed-input-row input {
        width: 110px;
      }
      .detailed-speed-section {
        margin-bottom: 40px;
      }
      .speed-chart-pair {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 40px;
      }
      @media (max-width: 1400px) {
        .speed-chart-pair {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body style="font-family: sans-serif;">
    <div id="toolbar" class="bg-dark border-bottom border-secondary shadow-sm">
      <div class="d-flex align-items-center gap-2 w-100">
        <div class="d-flex align-items-center gap-2">
          <span class="badge rounded-pill text-bg-primary">Pomiary & Wykresy</span>
          <input id="file-chooser" type="file" accept="image/*" class="form-control form-control-sm">
        </div>
        <div class="vr"></div>
        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-check-inline m-0">
            <input id="show-angles" type="checkbox" checked="1" class="form-check-input">
            <label for="show-angles" class="form-check-label">Show &#x2222;</label>
          </div>
          <div class="form-check form-check-inline m-0">
            <input id="show-deltas" type="checkbox" class="form-check-input">
            <label for="show-deltas" class="form-check-label">Show dx/dy</label>
          </div>
          <span id="tool-buttons" class="btn-group btn-group-sm" role="group" aria-label="Tools">
            <button id="mode-measure" type="button" class="btn btn-primary active">Measure</button>
            <button id="mode-scale" type="button" class="btn btn-outline-light">Scale</button>
            <button id="mode-erase" type="button" class="btn btn-outline-light">Eraser</button>
            <button id="mode-edit" type="button" class="btn btn-outline-light">Edit</button>
          </span>
          <div class="form-check form-check-inline m-0">
            <input id="snap-to-angle" type="checkbox" class="form-check-input">
            <label for="snap-to-angle" class="form-check-label" title="Snap to 45deg angles">Snap angle</label>
          </div>
        </div>
        <div class="vr"></div>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" aria-label="Export">
            <a id="download-result" class="btn btn-outline-info" download="pomiary-overlay.png">Overlay</a>
            <a id="download-combined" class="btn btn-outline-info" download="pomiary-z-wymiarami.png">With measurements</a>
            <a id="download-combined-table" class="btn btn-outline-info" download="pomiary-z-tabela.png">With table</a>
            <a id="download-table-image" class="btn btn-outline-info" download="tabela-pomiarow.png">Table image</a>
            <a id="download-table-csv" class="btn btn-outline-info" download="pomiary.csv">Table CSV</a>
          </div>
        </div>
        <span id="helptext" class="text-warning ms-auto"></span>
      </div>
    </div>
    <div id="measurements-panel" class="collapsed">
      <button id="measurements-toggle" type="button">Measurements</button>
      <div id="measurements-body">
        <div id="measurements-title">Measurements</div>
        <div id="measurements-scale"></div>
        <ol id="measurements-list"></ol>
      </div>
    </div>
    <canvas id="background-img" width="50" height="50"></canvas>
    <canvas id="measure" width="50" height="50" style="cursor:url(icons/target-cursor.png) 31 31,crosshair;"></canvas>
    <canvas id="loupe" width="280" height="280"></canvas>
    
    <button id="chart-toggle-btn" type="button" class="btn btn-warning btn-lg">üìä Analiza CSV</button>
    
    <div id="chart-analysis-section">
      <div id="chart-header">
        <h5 class="mb-0">Analiza pomiar√≥w z CSV</h5>
        <input id="csv-file-chooser" type="file" accept=".csv" multiple class="form-control form-control-sm" style="max-width: 400px;">
        <button id="generate-charts-btn" type="button" class="btn btn-primary btn-sm">Generuj wykresy</button>
        <button id="generate-speed-chart-btn" type="button" class="btn btn-outline-success btn-sm">Wykres ≈õrednia vs posuw</button>
        <button id="generate-detailed-speed-charts-btn" type="button" class="btn btn-outline-warning btn-sm">Szczeg√≥≈Çowe (anomalie + przedzia≈Çy)</button>
        <button id="download-histograms-btn" type="button" class="btn btn-success btn-sm">‚¨á Histogramy i scatter</button>
        <button id="download-speed-charts-btn" type="button" class="btn btn-success btn-sm">‚¨á Wykresy prƒôdko≈õci</button>
        <button id="chart-close-btn" type="button" class="btn btn-secondary btn-sm ms-auto">Zamknij</button>
      </div>
      <div id="chart-body">
        <div id="speed-summary-section" class="chart-container">
          <h6 class="text-light mb-3">≈örednia szeroko≈õƒá spoiny vs prƒôdko≈õƒá posuwu</h6>
          <div class="text-secondary mb-3" style="font-size: 10pt;">Wprowad≈∫ prƒôdko≈õƒá posuwu dla ka≈ºdej pr√≥bki, a potem kliknij ‚ÄûWykres ≈õrednia vs posuw‚Äù.</div>
          <div id="speed-inputs" class="speed-inputs"></div>
          <button id="download-speed-chart-btn" type="button" class="btn btn-info btn-sm chart-download-btn">‚¨á Pobierz wykres (PNG)</button>
          <div class="chart-canvas-wrapper" style="margin-top: 20px;">
            <canvas id="speed-summary-chart"></canvas>
          </div>
        </div>
        <div id="aggregate-speed-section" class="chart-container">
          <h6 class="text-light mb-3">Wszystkie pomiary vs prƒôdko≈õƒá posuwu (z anomaliami i przedzia≈Çami)</h6>
          <button id="generate-aggregate-speed-charts-btn" type="button" class="btn btn-outline-info btn-sm mb-3">Generuj wykresy (anomalie + przedzia≈Çy)</button>
          <div id="aggregate-charts-container"></div>
        </div>
        <div id="detailed-speed-section" class="detailed-speed-section"></div>
        <div id="charts-output"></div>
      </div>
    </div>
    
    <script>augenmass_init();</script>
    <script src="js/augenmass-charts.js"></script>
  </body>
</html>
